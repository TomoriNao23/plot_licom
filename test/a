output                 = "/home/yyq/mls/dataprocess/photo/tt"
datapath               = "/data06/yyq/mls/licom2/addwater_new/exe/"
gridpath               = "/home/yyq/mls/dataprocess/nc/basin_new.nc"
fileslist              = systemfunc("ls "+ datapath+"MMEAN" +"*") 
f                      = addfiles(fileslist, "r") 
f_grid                 = addfile(gridpath, "r")

lev                    = f[0]->lev1
lat                    = f[0]->lat
vs_a                   = f[348:359]->vs
ts_a                   = f[348:359]->ts
indd                    = f_grid->indd              ;各个大洋的掩膜

lat_size               = dimsizes(vs_a(0,0,:,0)) - 1
lon_size               = dimsizes(vs_a(0,0,0,:)) - 1 - 2
time_size              = dimsizes(vs_a(:,0,0,0)) - 1
lev_size               = dimsizes(lev) - 1
vs                     = vs_a(:,:,:,0:lon_size)
ts                     = ts_a(:,:,:,0:lon_size)

angle2radian           = 4.0 * atan(1.0) / 180.0    ; 角度转换弧度
r_earth                = 6.371e6                    ; 地球半径
dlon                   = 2                          ; 格点的纬向分辨率
Cp                     = 4.18e3                     ; 热容
rho0                   = 1027                       ; 海水密度

r                      = r_earth * cos (lat * angle2radian)
dx                     = r * (dlon * angle2radian)
dz = new((/lev_size/),typeof(lev))
do z = 1,lev_size
    dz(z-1) = ((lev(z) - lev(z-1))) * (-1)
end do 

dz_conform = new((/time_size+1,lev_size,lat_size+1,lon_size+1/),float)          ;[12]  x [30]  x [115]  x [180]
dz_conform=conform(dz_conform, dz, (/1/))

dx_conform = new((/time_size+1,lev_size,lat_size+1,lon_size+1/),float)          ;[12]  x [30]  x [115]  x [180]
dx_conform=conform(dx_conform, dx, (/2/))

heat = vs * ts * dz_conform * dx_conform * Cp * rho0                            ;[12]  x [30]  x [115]  x [180]
heat_integrate_lev =dim_sum_n(heat, 1)                                          ;[12]  x [115] x [180]
heat_avg = dim_avg_n(heat_integrate_lev,0)                                      ;[115] x [180]

;all basin
heat_avg_lat = dim_avg_n(heat_avg,1)                                            ;[115]
heat_avg_lat = runave (heat_avg_lat, 9, 0)
;pacfic
heat_avg_pacfic     = where(indd.eq.4, heat_avg, heat_avg@_FillValue)
heat_avg_lat_pacfic = dim_avg_n(heat_avg_pacfic,1)
;heat_avg_lat_pacfic = runave (heat_avg_lat_pacfic, 9, 0)
;Atlantic
heat_avg_atlantic     = where(indd.eq.2, heat_avg, heat_avg@_FillValue)
heat_avg_lat_atlantic = dim_avg_n(heat_avg_atlantic,1)
;heat_avg_lat_atlantic = runave (heat_avg_lat_atlantic, 9, 0)
;indo
heat_avg_indo     = where(indd.eq.3, heat_avg, heat_avg@_FillValue)
heat_avg_lat_indo = dim_avg_n(heat_avg_indo,1)
;heat_avg_lat_indo = runave (heat_avg_lat_indo, 9, 0)

wks      = gsn_open_wks("png", output)
plots    = new(1,"graphic")
res_0    = True
    res_0@gsnDraw                =  False
    res_0@gsnFrame               =  False
    res_0@tiXAxisString          =  "Latitude" 
    res_0@tiYAxisString          =  "Meridional Heat Transport" 

plots(0) = gsn_csm_xy(wks, lat,heat_avg_lat_atlantic, res_0)
plots_pacfic = gsn_csm_xy(wks, lat,heat_avg_lat_pacfic, res_0)
plots_atlantic = gsn_csm_xy(wks, lat,heat_avg_lat_atlantic, res_0)
plots_indo = gsn_csm_xy(wks, lat,heat_avg_lat_indo, res_0)
;overlay( plots(0),plots_pacfic)
;overlay( plots(0),plots_atlantic)
;overlay( plots(0),plots_indo)

resP     = True
gsn_panel(wks, plots, (/1,1/), resP)











